#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   DOMAIN=jevido.wtf EMAIL=you@domain.com ./setup-bakery.sh

# ===‚Ää‚Äî‚ÄäCONFIG‚Ää‚Äî‚Ää====
DOMAIN=${DOMAIN:?‚ÄúPlease set DOMAIN=your.domain‚Äù}
EMAIL=${EMAIL:?‚ÄúPlease set EMAIL=your@email‚Äù}

APP_USER=bakery
BAKERY_ROOT=/srv/bakery

echo "üçû  [setup-bakery] Starting setup for $DOMAIN ‚Ä¶"
sudo mkdir -p /etc/bakery
echo "DOMAIN=$DOMAIN" | sudo tee /etc/bakery/config > /dev/null
echo "EMAIL=$EMAIL" | sudo tee -a /etc/bakery/config > /dev/null

# 1Ô∏è‚É£ Create bakery user
if ! id -u $APP_USER >/dev/null 2>&1; then
  sudo useradd -m -s /bin/bash $APP_USER
  echo "‚úî Created user: $APP_USER"
else
  echo "‚Ñπ  User $APP_USER already exists"
fi

# 2Ô∏è‚É£ Make directory structure
sudo mkdir -p $BAKERY_ROOT/{apps,db,bin,certs,logs}
sudo chown -R $APP_USER:$APP_USER $BAKERY_ROOT

# 3Ô∏è‚É£ Install system packages
sudo apt update
sudo apt install -y curl gnupg2 unzip \
     postgresql \
     ufw certbot

# 4Ô∏è‚É£ Bun
if ! command -v bun >/dev/null; then
  curl -fsSL https://bun.sh/install | bash
  echo "export PATH=\"\$HOME/.bun/bin:\$PATH\"" \
    | sudo tee -a /home/$APP_USER/.bashrc
  echo "‚úî Installed Bun"
else
  echo "‚Ñπ  Bun already installed"
fi

# 5Ô∏è‚É£ Firewall
sudo ufw allow OpenSSH
sudo ufw allow https
sudo ufw --force enable

# 6Ô∏è‚É£ PostgreSQL
sudo systemctl enable --now postgresql
echo "‚úî PostgreSQL up"

# 7Ô∏è‚É£ Certs folder
sudo mkdir -p /etc/letsencrypt/{live,archive}
sudo chown -R root:root /etc/letsencrypt

# 8Ô∏è‚É£ Deploy helper scripts
echo "‚úî Copying bakery CLI & scripts‚Ä¶"
sudo install -m755 bin/bakery /usr/local/bin/bakery
sudo install -m755 bin/deploy-app.sh bin/remove-app.sh bin/upgrade-bakery.sh \
     $BAKERY_ROOT/bin/
sudo chown -R $APP_USER:$APP_USER $BAKERY_ROOT/bin
sudo chmod +x $BAKERY_ROOT/bin/*.sh

ls -l "$BAKERY_ROOT/bin"
echo "‚úÖ  Done! You can now:"

cat <<EOF
  ‚Ä¢ ssh root@<your-server> "bakery"        # see CLI help
  ‚Ä¢ bakery install                       # same thing from bakery user
  ‚Ä¢ bakery deploy app.$DOMAIN            # deploy apps/pull certs/etc
EOF
